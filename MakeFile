  GNU nano 6.2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Makefile
# ========================
#   Django Call System - Makefile
# ========================

# Load .env file if exists
ifneq (,$(wildcard .env))
    include .env
    export
endif

# Backend API endpoints
API_BASE  = https://api-dinodial-proxy.cyces.co
TOKEN_API = $(API_BASE)/api/proxy/token/cud/
CALL_API  = $(API_BASE)/api/proxy/make-call/

AUDIO_DIR = audio-assets
PROMPT_FILE = prompts/english.txt
EVALUATION_TOOL_FILE = evaluationTool.json

VOICE_NAME = Leda
MODEL = gemini-2.5-flash-preview-tts

# -----------------------------
# 1. CREATE TOKEN
# Usage: make token PHONE=+91XXXXXXXXXX
# -----------------------------
export ADMIN_TOKEN = dXNlcjEyMy1zZXNzaW9uLXRva2Vu
export GEMINI_API_KEY = AIzaSyC3fe0dQDw7YkYuaH1K5iEQq5TU7lers9E

token:
ifndef PHONE
        $(error PHONE is required. Usage: make token PHONE=+91XXXXXXXXXX)
endif
ifeq ($(strip $(ADMIN_TOKEN)),)
        $(error ADMIN_TOKEN is missing in .env)
endif
        @echo "Creating proxy token for $(PHONE)... using admin token"
        curl -X POST $(TOKEN_API) \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $(ADMIN_TOKEN)" \
                -d "{\"phone_number\": \"$(PHONE)\"}"

# -----------------------------
# 2. GENERATE ALL AUDIO FILES
# -----------------------------
audio: intro error timelimit idle
        @echo "All audio generated."

intro:
        @chmod +x scripts/gen_intro.sh
        @scripts/gen_intro.sh

error:
        @chmod +x scripts/gen_error.sh
        @scripts/gen_error.sh

timelimit:
        @chmod +x scripts/gen_timelimit.sh
        @scripts/gen_timelimit.sh

idle:
        @chmod +x scripts/gen_idle.sh
        @scripts/gen_idle.sh

# -----------------------------
# 3. TRIGGER CALL
# Usage: make call TOKEN=xxxxx
# -----------------------------
call:
ifndef TOKEN
        $(error TOKEN is required)
endif
        @[ -f "$(PROMPT_FILE)" ] || { echo "Prompt file not found: $(PROMPT_FILE)"; exit 1; }
        @[ -f "$(EVALUATION_TOOL_FILE)" ] || { echo "Evaluation tool file not found: $(EVALUATION_TOOL_FILE)"; exit 1; }
        @echo "=== Making development call ==="
        @jq -n \
                --rawfile prompt "$(PROMPT_FILE)" \
                --slurpfile evaluation_tool "$(EVALUATION_TOOL_FILE)" \
                '{prompt: $$prompt, evaluation_tool: $$evaluation_tool[0]}' \
                | curl -X POST $(CALL_API) \
                  -H "Content-Type: application/json" \
                  -H "Authorization: Bearer $(TOKEN)" \
                  --data-binary @-
# -----------------------------
# 4. LIST CALLS
list-calls:
ifndef TOKEN
        $(error TOKEN is required. Usage: make calls TOKEN=xxxxx)
endif
        curl -X GET $(API_BASE)/api/proxy/calls/list/ \
                -H "Authorization: Bearer $(TOKEN)"

# ================================
#  GET CALL DETAIL
#  Usage: make call_detail TOKEN=xxxx CALL_ID=123
# ================================
call_detail:
ifndef TOKEN
        $(error TOKEN is required)
endif
ifndef CALL_ID
        $(error CALL_ID is required)
endif
        curl -X GET $(API_BASE)/api/proxy/call/detail/$(CALL_ID)/ \
                -H "Authorization: Bearer $(TOKEN)"

# ================================
#  GET RECORDING URL
#  Usage: make recording_url TOKEN=xxxx CALL_ID=123
# ================================
recording_url:
ifndef TOKEN
        $(error TOKEN is required)
endif
ifndef CALL_ID
        $(error CALL_ID is required)
endif
        curl -X GET $(API_BASE)/api/proxy/recording-url/$(CALL_ID)/ \
                -H "Authorization: Bearer $(TOKEN)"

.PHONY: token audio intro error idle timelimit call list-calls call_detail recording_url
























